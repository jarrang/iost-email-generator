import React, { useEffect, useMemo, useRef, useState } from "react";

// --- Utility helpers ---
const readFileAsDataURL = (file) =>
  new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });

function download(filename, text) {
  const el = document.createElement("a");
  el.setAttribute(
    "href",
    URL.createObjectURL(new Blob([text], { type: "text/html;charset=utf-8" }))
  );
  el.setAttribute("download", filename);
  el.style.display = "none";
  document.body.appendChild(el);
  el.click();
  document.body.removeChild(el);
}

// ================= MAIN EMAIL TEMPLATE (YOUR JARRANG CODE) =================
// Notes:
//  - I replaced your hidden preheader with {{preheader}}
//  - I parameterised the hero image/link/alt, lead block fields, and the repeated STORIES area
//  - I removed your fixed two story blocks and inserted {{stories_html}} instead (so you can choose any count)
//  - Everything else is left intact
const DEFAULT_TEMPLATE = `
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" style="background-color: #f1f3f1; color-scheme: light dark; supported-color-schemes: light dark;">
<head>
<!--[if gte mso 9]><xml>
<o:OfficeDocumentSettings>
<o:AllowPNG/>
<o:PixelsPerInch>96</o:PixelsPerInch>
</o:OfficeDocumentSettings>
</xml><![endif]-->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="x-ua-compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark">
<title>Email Newsletter</title>
<!-- Developed by Jarrang - https://www.jarrang.com/ -->
<style type="text/css">
@import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,700;1,400&display=swap');
</style>
<style type="text/css">
body{margin:0;padding:0}table{border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0}h1{margin:.67em 0;font-size:2em}h2{margin:.83em 0;font-size:1.5em}html[dir] h3,h3{margin:1em 0;font-size:1.17em}span.MsoHyperlink{color:inherit !important;mso-style-priority:99 !important}span.MsoHyperlinkFollowed{color:inherit !important;mso-style-priority:99 !important}a[x-apple-data-detectors=true]{color:inherit !important;text-decoration:inherit !important}div[style*="margin: 16px 0"]{margin:0 !important}
</style>
<style type="text/css">
[style*=Montserrat]{font-family:"Montserrat",sans-serif !important}:root{color-scheme:light dark;supported-color-schemes:light dark}_:-webkit-full-screen,_::-webkit-full-page-media,_:future{display:block !important}_:-webkit-full-screen,_::-webkit-full-page-media,_:future{display:none !important}
@media only screen and (max-width: 580px){html,body,.main-background{padding:0}*{box-sizing:border-box !important}.content-outer{width:100% !important;height:auto !important;box-sizing:border-box}.content-inner{width:93.5483870968% !important;height:auto !important}.sect{width:100% !important;height:auto !important}.side{width:3.4482758621% !important}.block{width:100% !important;min-width:100% !important;display:block !important;clear:both !important;float:left !important}img.fill{width:100% !important;height:auto !important;display:block !important}.mobile-text-center{text-align:left !important}.mobile-text-center2{text-align:center !important}.button-mobile-center{margin:0 auto !important;text-align:center !important}.fullWidth{width:100% !important}.hideonmobile{display:none !important}.zeroBorder{padding:0px !important}.zeroBorderSides{padding-left:0px !important;padding-right:0px !important}.navPadding2{padding-top:0px !important;padding-bottom:20px !important}.footPad{padding-top:20px !important;padding-bottom:50px !important}.menufont{font-size:12px !important;line-height:15px !important;color:#979c9c !important}.desktop{display:none !important}.mobile{display:block !important;width:auto !important;max-height:inherit !important}.floatc{float:none !important}.width45{width:45px !important}}
@media screen and (max-width: 580px){img.fill{max-width:100% !important;width:100% !important}video{width:100% !important}}
@media (prefers-color-scheme: dark){html,body,.main-background{background-color:#1e1e1e !important}.content-outer{background-color:#1e1e1e !important}img{filter:brightness(0.9) !important}td{color:#a9a9a9 !important}.button td a{color:#fff !important}strong,h1,h2,h3{color:#fff !important}}
</style>
</head>
<body style="-webkit-font-smoothing: antialiased; -webkit-text-size-adjust: none; background-color: #f1f3f1; color: #c4c4c4; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 16px; line-height: 1.3; min-width: 100% !important; width: 100% !important;">
<div style="display: none; max-height: 0px; overflow: hidden;">{{preheader}}</div>
<div class="main-background" style="background-color: #f1f3f1;">
<table role="presentation" align="center" cellspacing="0" cellpadding="0" border="0" style="width: 100%;">
<tr>
<td align="center" style="width: 100%;">

<!-- START .preheader-01 (logo/navigation blocks retained as-is) -->
<table role="presentation" class="content-outer" align="center" cellspacing="0" cellpadding="0" border="0" style="background-color: #ffffff; width: 620px;">
<tr>
<td class="side" style="width: 40px;"></td>
<td class="content-inner" valign="top" align="center" style="width: 540px;">
<div style="clear: both; display: block; font-size: 30px; height: 30px; line-height: 30px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;"> &nbsp; </div>
<table role="presentation" class="sect" border="0" cellspacing="0" cellpadding="0" align="center" style="width: 100%;">
<tr>
<td class="block mobile-text-center2" valign align="center" style="padding-right: 30px; text-align: center; width: 100%;">
<a href="https://www.islesofscilly-travel.co.uk/" target="_blank">
<img src="https://cdn.client.jarrang.com/c2208/d1e642176cb8e9c143bb8d0775605995.png" width="100" style="border: none; display: inline-block; height: auto; outline: none; text-decoration: none;" alt="IOST logo">
</a>
</td>
</tr>
</table>
<div style="clear: both; display: block; font-size: 30px; height: 30px; line-height: 30px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;"> &nbsp; </div>
</td>
<td class="side" style="width: 40px;"></td>
</tr>
</table>

<!-- START .fw-image (HERO) -->
<table role="presentation" class="content-outer" align="center" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; width: 620px;">
<tr>
<td class="content-inner" valign="top" align="center" style="width: 540px;">
<table role="presentation" class="sect" align="center" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr>
<td class="block" valign="top" align="center" style="width: 100%;">
<div>
<a href="{{hero_link}}" target="_blank">
<img class="fill" src="{{hero_src}}" alt="{{hero_alt}}" width="620" height="620" align="top" style="border: none; display: block; height: auto; outline: none; text-decoration: none;">
</a>
</div>
</td>
</tr>
</table>
</td>
</tr>
</table>
<!-- END .fw-image -->

<!-- START .fw-lead (INTRO COPY) -->
<table role="presentation" class="content-outer" align="center" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; width: 620px;">
<tr>
<td class="side" style="width: 40px;">&nbsp;</td>
<td class="content-inner" align="center" style="width: 540px;">
<table role="presentation" class="sect" align="center" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr><td><div style="clear: both; display: block; font-size: 30px; height: 30px; line-height: 30px;">&nbsp;</div></td></tr>
<tr>
<td class="mobile-text-center" style="text-align: left;">
<h1 style="color: #66b0bd; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 24px; font-style: italic; font-weight: normal; line-height: 28px; margin-top: 0;">
<span style="font-family: 'Montserrat', sans-serif !important;">{{lead_headline}}</span>
</h1>
</td>
</tr>
<tr><td><div style="clear: both; display: block; font-size: 10px; height: 10px; line-height: 10px;">&nbsp;</div></td></tr>
<tr>
<td class="mobile-text-center" style="color: #979C9C; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 16px; line-height: 20px; text-align: left;">{{lead_body_copy}}</td>
</tr>
<tr><td><div style="clear: both; display: block; font-size: 20px; height: 20px; line-height: 20px;">&nbsp;</div></td></tr>
<tr>
<td>
<table role="presentation" class="sect" align="center" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr>
<td class="block" valign="middle" align="center" style="width: 100%;">
<table role="presentation" class="button button-mobile-center" cellspacing="0" cellpadding="0" border="0" style="background-color: transparent; border: 2px solid #66b0bd; border-collapse: separate; border-radius: 10px;">
<tr>
<td align="center" style="color: #66b0bd; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 15px; font-weight: bold; line-height: 20px; padding: 10px 60px; text-align: center; text-transform: uppercase; width: 100%;">
<a href="{{lead_cta_url}}" target="_blank" style="color: #66b0bd; text-decoration: none;">{{lead_cta_text}}</a>
</td>
</tr>
</table>
</td>
</tr>
</table>
</td>
</tr>
<tr><td><div style="clear: both; display: block; font-size: 30px; height: 30px; line-height: 30px;">&nbsp;</div></td></tr>
</table>
</td>
<td class="side" style="width: 40px;">&nbsp;</td>
</tr>
</table>
<!-- END .fw-lead -->

<!-- ================= STORIES SLOT ================= -->
{{stories_html}}
<!-- =============== END STORIES SLOT =============== -->

<!-- ======= FOOTER (unchanged from your code) ======= -->
<table width="620" class="fullWidth" bgcolor="#ffffff" border="0" cellspacing="0" cellpadding="0" align="center" style="width: 620px">
<tr>
<td width="100%" class bgcolor="#ffffff" align="left" style="font-size:1px; line-height:0; -webkit-text-size-adjust:none; padding:30px 20px 30px 20px">
<table width="390" class="fullWidth" bgcolor="#ffffff" border="0" cellspacing="0" cellpadding="0" align="center">
<tr>
<td width="20%" class="zeroBorderSides" bgcolor="#ffffff" align="center" style="padding:0"><a href="https://www.islesofscilly-travel.co.uk/skybus/" target="_blank">
<img style="border: none; display: block; height: auto; outline: none; text-decoration: none;" src="https://cdn.client.jarrang.com/c2208/47399874fed475abcacc5037c9ecff46.png" width="58" height="91" alt="Skybus"></a>
</td>
<td width="20%" class="zeroBorderSides" bgcolor="#ffffff" align="center" style="padding:0"><a href="https://www.islesofscilly-travel.co.uk/timetable-fares/" target="_blank">
<img style="border: none; display: block; height: auto; outline: none; text-decoration: none;" src="https://cdn.client.jarrang.com/c2208/8b1320a57e7c7bbba5d3ba5eb9dcc21e.png" width="78" height="91" alt="Timetables"></a>
</td>
<td width="20%" class="zeroBorderSides" bgcolor="#ffffff" align="center" style="padding:0"><a href="https://www.islesofscilly-travel.co.uk/scillonian-iii/" target="_blank">
<img style="border: none; display: block; height: auto; outline: none; text-decoration: none;" src="https://cdn.client.jarrang.com/c2208/c81e4ee884c807d06f5163c09f86f601.png" width="78" height="91" alt="Scillonian iii"></a>
</td>
<td width="20%" class="zeroBorderSides" bgcolor="#ffffff" align="center" style="padding:0"><a href="https://www.islesofscilly-travel.co.uk/dog-friendly-holidays/" target="_blank">
<img style="border: none; display: block; height: auto; outline: none; text-decoration: none;" src="https://cdn.client.jarrang.com/c2208/b121eb8b257319577d833621278611e1.png" width="78" height="91" alt="Pet travel"></a>
</td>
<td width="20%" class="zeroBorderSides" bgcolor="#ffffff" align="center" style="padding:0"><a href="https://www.islesofscilly-travel.co.uk/fares/" target="_blank">
<img style="border: none; display: block; height: auto; outline: none; text-decoration: none;" src="https://cdn.client.jarrang.com/c2208/1985f883bfa0a523d29cdb6358db68a8.png" width="78" height="91" alt="Fares"></a>
</td>
</tr>
</table>
</td>
</tr>
</table>
<table width="620" class="fullWidth" bgcolor="#E1ECED" border="0" cellspacing="0" cellpadding="0" align="center" style="width: 620px;">
<tr>
<td width="620" class="fullWidth" bgcolor="#E1ECED" align="left" style="width: 620px; font-size:1px; line-height:0; -webkit-text-size-adjust:none; padding:40px 0px 10px 0px; float: left">
<table width="390" class="hideonmobile" bgcolor="#E1ECED" border="0" cellspacing="0" cellpadding="0" align="left" style="float: left">
<tr>
<td width="130" class bgcolor="#E1ECED" align="left" style="padding:5px 230px 0px 30px">
<a href="https://www.islesofscilly-travel.co.uk/" target="_blank"><img class="hideonmobile" style="border: none; display: block; height: auto; outline: none; text-decoration: none;" src="https://cdn.client.jarrang.com/c2208/d1e642176cb8e9c143bb8d0775605995.png" width="130" height="30" alt="IOST logo"></a>
</td>
</tr>
</table>
<table width="210" class="floatc" bgcolor="#E1ECED" border="0" cellspacing="0" cellpadding="0" align="center" style="float: right; ">
<tr>
<td width="45" class="zeroBorderSides" bgcolor="#E1ECED" align="left" style="padding:0 7px 20px 0"><a href="https://twitter.com/IOSTRAVEL" target="_blank">
<img src="https://cdn.client.jarrang.com/c2208/44099e03f4dab307263ddd758cac2a54.png" width="38" height="38" alt="Twitter"></a>
</td>
<td width="45" class="zeroBorderSides" bgcolor="#E1ECED" align="left" style="padding:0 7px 20px 0"><a href="https://www.facebook.com/islesofscillytravel" target="_blank">
<img src="https://cdn.client.jarrang.com/c2208/c99792d3e48f7d24caa4cd343e7864b1.png" width="38" height="38" alt="Facebook"></a>
</td>
<td width="45" class="zeroBorderSides" bgcolor="#E1ECED" align="left" style="padding:0 7px 20px 0"><a href="https://www.youtube.com/channel/UClziofaoLUnzX194zkKFt4Q" target="_blank">
<img src="https://cdn.client.jarrang.com/c2208/72655c2b7108cfe285814816171ba3d9.png" width="38" height="38" alt="Youtube"></a>
</td>
<td width="75" class="zeroBorderSides width45" bgcolor="#E1ECED" align="left" style="padding:0 30px 20px 0"><a href="https://www.instagram.com/islesofscillytravel/" target="_blank">
<img src="https://cdn.client.jarrang.com/c2208/e55006325655a85a5da51b8abf390bf5.png" width="38" height="38" alt="Instagram"></a>
</td>
</tr>
</table>
</td>
</tr>
</table>
<table width="620" class="fullWidth" bgcolor="#E1ECED" border="0" cellspacing="0" cellpadding="0" align="center" style="width: 620px;">
<tr>
<td width="100%" class="fullWidth" align="center" bgcolor="#E1ECED" style="-webkit-text-size-adjust:none; line-height:0px; padding:0 50px 20px 50px">
<span style="font-family:Arial, Helvetica, sans-serif; font-size:12px; line-height:18px; color:#304178;">Isles of Scilly Travel is a trading name of Isles of Scilly Shipping Company Limited (<a href="#" style="color: #304178; text-decoration: none;">05012204</a>) and Isles of Scilly Skybus Limited (<a href="#" style="color: #304178; text-decoration: none;">01802523</a>), companies registered in England and Wales. Registered office: Steamship House, Quay Street, Penzance, Cornwall TR18 4BZ. VAT number: <a href="#" style="color: #304178; text-decoration: none;">383879196</a>
<br><br>
<strong><a href="[weblink]" style="color: #304178; text-decoration: underline;">View online</a> | <a href="[gunsub;https://www.islesofscilly-travel.co.uk/unsubscribe/]" style="color: #304178; text-decoration: underline;">Unsubscribe</a></strong>
</span>
</td>
</tr>
</table>
<table width="620" class="fullWidth" bgcolor="#E1ECED" border="0" cellspacing="0" cellpadding="0" align="center" style="width: 620px;">
<tr>
<td style="text-align:center;font-size:0px;" class="fullWidth footPad">
<img src="https://cdn.client.jarrang.com/c2208/8bae84e24cf419925bd56c07056695cd.png" width="620" height="115" alt="" style="border-width: 0px; display: block; height: 115px; outline: none; text-decoration: none;" class="desktop">
<!--[if !mso]><!-- -->
<div style="width:0px;max-height:0px;overflow:hidden;display:none;" class="mobile">
<a href="https://www.islesofscilly-travel.co.uk/" target="_blank" style="color: #ffffff; text-decoration:underline;"> <img src="https://cdn.client.jarrang.com/c2208/0e8fcd6316f772c24e0efaf899dae463.png" width="100" height="51" alt="" style="border: none; border-width: 0; display: inline-block; height: auto; outline: none; text-decoration: none;"></a>
</div>
<!--<![endif]-->
</td>
</tr>
</table>

</td></tr></table></div></body></html>`;

// ============== STORY ITEM (MODULE) TEMPLATES =================
// LEFT layout (image left, copy right)
const STORY_LEFT = `
<!-- START .story-1col (LEFT) -->
<table role="presentation" class="content-outer" align="center" border="0" cellspacing="0" cellpadding="0" style="background-color: #E1ECED; vertical-align: middle; width: 620px;">
<tr>
<td class="content-inner" valign="middle" align="center" style="width: 540px;">
<table role="presentation" class="sect" align="center" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr>
<td class="block" valign="middle" style="width: 310px;">
<div>
<a href="{{image_url}}" target="_blank">
<img class="fill" src="{{image_src}}" alt="{{alt}}" width="350" height="300" align="top" style="border: none; display: block; height: auto; outline: none; text-decoration: none;">
</a>
</div>
</td>
<td class="block" valign="middle" style="width: 310px;">
<table class="sect" role="presentation" align="left" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr><td valign="middle" style="padding: 20px;">
<table class="sect" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr><td><div style="font-size:0;height:0;line-height:0;">&nbsp;</div></td></tr>
<tr><td class="mobile-text-center" style="text-align: left;"><span style="color: #66b0bd; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 18px; line-height: 24px;">{{headline}}</span></td></tr>
<tr><td class="mobile-text-center" style="color: #979C9C; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 14px; line-height: 19px; padding-top: 5px; text-align: left;">{{body_copy}}</td></tr>
<tr><td><div style="font-size:15px;height:15px;line-height:15px;">&nbsp;</div></td></tr>
<tr><td>
<table class="sect" role="presentation" align="left" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr><td class="block" valign="top" align="left" style="width: 100%;">
<table role="presentation" class="button button-mobile-center" cellspacing="0" cellpadding="0" border="0" style="background-color: transparent; border: 2px solid #66b0bd; border-radius: 10px;">
<tr><td align="center" style="color: #66b0bd; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 15px; font-weight: bold; line-height: 20px; padding: 6px 20px; text-align: center; text-transform: uppercase; width: 100%;">
<a href="{{cta_url}}" target="_blank" style="color: #66b0bd; text-decoration: none;">{{cta_text}}</a>
</td></tr>
</table>
</td></tr>
</table>
</td></tr>
<tr><td><div style="font-size:0;height:0;line-height:0;">&nbsp;</div></td></tr>
</table>
</td>
</tr>
</table>
</td>
</tr>
</table>
<!-- END .story-1col (LEFT) -->`;

// RIGHT (reversed) layout using dir="rtl" on container like your second block
const STORY_RIGHT = `
<!-- START .story-1col (RIGHT) -->
<table role="presentation" class="content-outer" align="center" border="0" cellspacing="0" cellpadding="0" style="background-color: #f3f2f0; vertical-align: middle; width: 620px;">
<tr>
<td class="content-inner" valign="middle" align="center" style="width: 540px;">
<table role="presentation" dir="rtl" class="sect" align="center" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr>
<td dir="ltr" class="block" valign="middle" style="width: 310px;">
<div>
<a href="{{image_url}}" target="_blank">
<img class="fill" src="{{image_src}}" alt="{{alt}}" width="350" height="300" align="top" style="border: none; display: block; height: auto; outline: none; text-decoration: none;">
</a>
</div>
</td>
<td dir="ltr" class="block" valign="middle" style="width: 310px;">
<table class="sect" role="presentation" align="left" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr><td valign="middle" style="padding: 20px;">
<table class="sect" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr><td><div style="font-size:0;height:0;line-height:0;">&nbsp;</div></td></tr>
<tr><td class="mobile-text-center" style="text-align: left;"><span style="color: #66b0bd; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 18px; line-height: 24px;">{{headline}}</span></td></tr>
<tr><td class="mobile-text-center" style="color: #979C9C; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 14px; line-height: 19px; padding-top: 5px; text-align: left;">{{body_copy}}</td></tr>
<tr><td><div style="font-size:15px;height:15px;line-height:15px;">&nbsp;</div></td></tr>
<tr><td>
<table class="sect" role="presentation" align="left" border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
<tr><td class="block" valign="top" align="left" style="width: 100%;">
<table role="presentation" class="button button-mobile-center" cellspacing="0" cellpadding="0" border="0" style="background-color: transparent; border: 2px solid #66b0bd; border-radius: 10px;">
<tr><td align="center" style="color: #66b0bd; font-family: sans-serif, Arial, Helvetica, 'Montserrat'; font-size: 15px; font-weight: bold; line-height: 20px; padding: 6px 20px; text-align: center; text-transform: uppercase; width: 100%;">
<a href="{{cta_url}}" target="_blank" style="color: #66b0bd; text-decoration: none;">{{cta_text}}</a>
</td></tr>
</table>
</td></tr>
</table>
</td></tr>
<tr><td><div style="font-size:0;height:0;line-height:0;">&nbsp;</div></td></tr>
</table>
</td>
</tr>
</table>
</td>
</tr>
</table>
<!-- END .story-1col (RIGHT) -->`;

// ----- Minimal templating: {{var}} and {{#if var}}...{{/if}} -----
function applyTemplate(tpl, vars) {
  let out = tpl;
  out = out.replace(/\{\{#if\s+([\w_]+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (m, name, inner) => (vars[name] ? inner : ""));
  out = out.replace(/\{\{([\w_]+)\}\}/g, (m, name) => (vars[name] ?? ""));
  return out;
}

export default function App() {
  // Global / hidden preheader
  const [preheader, setPreheader] = useState("");

  // Hero
  const [heroLink, setHeroLink] = useState("");
  const [heroSrc, setHeroSrc] = useState("https://placehold.co/620x620");
  const [heroAlt, setHeroAlt] = useState("");

  // Lead block
  const [leadHeadline, setLeadHeadline] = useState("A beautiful archipelago adventure awaits");
  const [leadBody, setLeadBody] = useState("<p>Intro / overview copy goes here. Keep it concise and inbox‑friendly.</p>");
  const [leadCtaText, setLeadCtaText] = useState("Discover more");
  const [leadCtaUrl, setLeadCtaUrl] = useState("");

  // Stories (repeatable modules)
  const [storyCount, setStoryCount] = useState(2);
  const [stories, setStories] = useState([
    { headline: "Story 1 headline", body_copy: "<p>Short teaser for story 1…</p>", image_url: "", image_src: "https://placehold.co/350x300", alt: "", cta_text: "Read more", cta_url: "", reverse: false },
    { headline: "Story 2 headline", body_copy: "<p>Short teaser for story 2…</p>", image_url: "", image_src: "https://placehold.co/350x300", alt: "", cta_text: "Read more", cta_url: "", reverse: true },
  ]);

  // Image embedding toggle
  const [embedImages, setEmbedImages] = useState(true);

  const iframeRef = useRef(null);

  // Keep stories length in sync with count
  useEffect(() => {
    setStories((prev) => {
      const copy = [...prev];
      if (storyCount > copy.length) {
        while (copy.length < storyCount) {
          copy.push({ headline: `Story ${copy.length + 1} headline`, body_copy: "<p>Short teaser…</p>", image_url: "", image_src: "https://placehold.co/350x300", alt: "", cta_text: "Read more", cta_url: "", reverse: copy.length % 2 === 1 });
        }
      } else if (storyCount < copy.length) {
        copy.length = storyCount;
      }
      return copy;
    });
  }, [storyCount]);

  const handleHeroFile = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    if (!embedImages) return alert("Embedding is off. Host the image and paste the URL.");
    const dataUrl = await readFileAsDataURL(file);
    setHeroSrc(dataUrl);
  };

  const handleStoryFile = async (e, idx) => {
    const file = e.target.files?.[0];
    if (!file) return;
    if (!embedImages) return alert("Embedding is off. Host the image and paste the URL.");
    const dataUrl = await readFileAsDataURL(file);
    setStories((prev) => { const c=[...prev]; c[idx] = { ...c[idx], image_src: dataUrl }; return c; });
  };

  const stories_html = useMemo(() => {
    return stories.map((s) => applyTemplate(s.reverse ? STORY_RIGHT : STORY_LEFT, s)).join("\n");
  }, [stories]);

  const finalHtml = useMemo(() => {
    return applyTemplate(DEFAULT_TEMPLATE, {
      preheader,
      hero_link: heroLink,
      hero_src: heroSrc,
      hero_alt: heroAlt,
      lead_headline: leadHeadline,
      lead_body_copy: leadBody,
      lead_cta_text: leadCtaText,
      lead_cta_url: leadCtaUrl,
      stories_html,
    });
  }, [preheader, heroLink, heroSrc, heroAlt, leadHeadline, leadBody, leadCtaText, leadCtaUrl, stories_html]);

  const writePreview = () => {
    if (!iframeRef.current) return;
    const doc = iframeRef.current.contentDocument;
    doc.open(); doc.write(finalHtml); doc.close();
  };

  const copyHtml = async () => {
    try { await navigator.clipboard.writeText(finalHtml); alert("HTML copied to clipboard"); }
    catch { alert("Copy failed. Your browser may block clipboard access."); }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800">
      <header className="p-6 border-b bg-white sticky top-0 z-10">
        <div className="max-w-6xl mx-auto flex items-center justify-between gap-4">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-2xl bg-blue-600"/>
            <div>
              <h1 className="text-xl font-semibold">Email HTML Generator — Jarrang Template</h1>
              <p className="text-sm text-slate-500">Pick # of stories, plug content, export email‑safe HTML</p>
            </div>
          </div>
          <div className="flex gap-2">
            <button onClick={() => download("newsletter.html", finalHtml)} className="px-4 py-2 rounded-xl bg-blue-600 text-white shadow hover:bg-blue-700">Download HTML</button>
            <button onClick={copyHtml} className="px-4 py-2 rounded-xl bg-slate-900 text-white shadow hover:bg-black">Copy HTML</button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto grid lg:grid-cols-2 gap-6 p-6">
        {/* LEFT: Form */}
        <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6 border space-y-6">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold">Global settings</h2>
            <label className="text-sm inline-flex items-center gap-2 cursor-pointer">
              <input type="checkbox" className="h-4 w-4" checked={embedImages} onChange={(e)=>setEmbedImages(e.target.checked)} />
              Embed uploaded images (base64)
            </label>
          </div>

          <div className="grid grid-cols-1 gap-4">
            <div>
              <label className="block text-sm font-medium">Preheader (hidden)</label>
              <input value={preheader} onChange={(e)=>setPreheader(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Short inbox preview text" />
            </div>
          </div>

          <hr/>
          <h3 className="text-base font-semibold">Hero</h3>
          <div className="grid sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium">Hero link (on click)</label>
              <input value={heroLink} onChange={(e)=>setHeroLink(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="https://…" />
            </div>
            <div>
              <label className="block text-sm font-medium">Hero alt text</label>
              <input value={heroAlt} onChange={(e)=>setHeroAlt(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Descriptive alt" />
            </div>
            <div className="sm:col-span-2">
              <label className="block text-sm font-medium">Hero image URL or upload</label>
              <div className="flex gap-2">
                <input value={heroSrc} onChange={(e)=>setHeroSrc(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Paste image URL or upload" />
                <input type="file" accept="image/*" onChange={handleHeroFile} className="mt-1" />
              </div>
            </div>
          </div>

          <hr/>
          <h3 className="text-base font-semibold">Lead / intro</h3>
          <div className="grid grid-cols-1 gap-4">
            <div>
              <label className="block text-sm font-medium">Headline</label>
              <input value={leadHeadline} onChange={(e)=>setLeadHeadline(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2" />
            </div>
            <div>
              <label className="block text-sm font-medium">Body (HTML allowed)</label>
              <textarea value={leadBody} onChange={(e)=>setLeadBody(e.target.value)} rows={5} className="mt-1 w-full rounded-xl border px-3 py-2 font-mono text-xs" />
            </div>
            <div className="grid sm:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium">CTA text</label>
                <input value={leadCtaText} onChange={(e)=>setLeadCtaText(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2" />
              </div>
              <div>
                <label className="block text-sm font-medium">CTA URL</label>
                <input value={leadCtaUrl} onChange={(e)=>setLeadCtaUrl(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="https://…" />
              </div>
            </div>
          </div>

          <hr/>
          <div className="flex items-center justify-between">
            <h3 className="text-base font-semibold">Stories</h3>
            <div className="flex items-center gap-2">
              <label className="text-sm text-slate-600">Number of stories:</label>
              <input type="number" min={0} max={12} value={storyCount} onChange={(e)=>setStoryCount(parseInt(e.target.value || "0",10))} className="w-20 rounded-xl border px-3 py-1" />
            </div>
          </div>

          <div className="space-y-4">
            {stories.map((s, idx) => (
              <div key={idx} className="rounded-xl border p-3">
                <div className="flex items-center justify-between mb-2">
                  <strong>Story {idx + 1}</strong>
                  <label className="text-sm inline-flex items-center gap-2">
                    <input type="checkbox" checked={s.reverse} onChange={(e)=>setStories(p=>{const c=[...p]; c[idx] = { ...c[idx], reverse: e.target.checked }; return c;})} />
                    Reverse layout (image right)
                  </label>
                </div>
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium">Headline</label>
                    <input value={s.headline} onChange={(e)=>setStories(p=>{const c=[...p]; c[idx]={...c[idx], headline:e.target.value}; return c;})} className="mt-1 w-full rounded-xl border px-3 py-2" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium">CTA text</label>
                    <input value={s.cta_text} onChange={(e)=>setStories(p=>{const c=[...p]; c[idx]={...c[idx], cta_text:e.target.value}; return c;})} className="mt-1 w-full rounded-xl border px-3 py-2" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium">CTA URL</label>
                    <input value={s.cta_url} onChange={(e)=>setStories(p=>{const c=[...p]; c[idx]={...c[idx], cta_url:e.target.value}; return c;})} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="https://…" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium">Image link (on click)</label>
                    <input value={s.image_url} onChange={(e)=>setStories(p=>{const c=[...p]; c[idx]={...c[idx], image_url:e.target.value}; return c;})} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="https://…" />
                  </div>
                  <div className="sm:col-span-2">
                    <label className="block text-sm font-medium">Image URL or upload</label>
                    <div className="flex gap-2">
                      <input value={s.image_src} onChange={(e)=>setStories(p=>{const c=[...p]; c[idx]={...c[idx], image_src:e.target.value}; return c;})} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Paste image URL or upload" />
                      <input type="file" accept="image/*" onChange={(e)=>handleStoryFile(e, idx)} className="mt-1" />
                    </div>
                    {s.image_src && <img src={s.image_src} alt="story" className="mt-2 h-24 object-cover rounded-lg" />}
                  </div>
                </div>
                <div className="mt-2">
                  <label className="block text-sm font-medium">Body (HTML allowed)</label>
                  <textarea value={s.body_copy} onChange={(e)=>setStories(p=>{const c=[...p]; c[idx]={...c[idx], body_copy:e.target.value}; return c;})} rows={4} className="mt-1 w-full rounded-xl border px-3 py-2 font-mono text-xs" />
                </div>
              </div>
            ))}
          </div>
        </section>

        {/* RIGHT: Preview & docs */}
        <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6 border flex flex-col">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-semibold">Live preview</h2>
            <button onClick={writePreview} className="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 border">Refresh</button>
          </div>
          <iframe ref={iframeRef} title="Preview" className="w-full h-96 border rounded-xl" />

          <details className="mt-4">
            <summary className="cursor-pointer text-sm text-slate-600">Where each module maps</summary>
            <div className="mt-3 text-sm text-slate-600 space-y-2">
              <p><strong>Preheader</strong> → hidden div at the very top.</p>
              <p><strong>Hero</strong> → replaces your <code>.fw-image</code> block: <code>{{"{{hero_link}}"}}</code>, <code>{{"{{hero_src}}"}}</code>, <code>{{"{{hero_alt}}"}}</code>.</p>
              <p><strong>Lead</strong> → your <code>.fw-lead</code> block: <code>{{"{{lead_headline}}"}}</code>, <code>{{"{{lead_body_copy}}"}}</code>, <code>{{"{{lead_cta_text}}"}}</code>, <code>{{"{{lead_cta_url}}"}}</code>.</p>
              <p><strong>Stories</strong> → all story modules injected at <code>{{"{{stories_html}}"}}</code> using the two story templates (Left/Right). You can edit these templates in code if needed.</p>
            </div>
          </details>

          <div className="mt-4 text-xs text-slate-500">
            <p>Tip: Keep any custom module HTML table‑based with inline styles for best client coverage. If your ESP requires hosted images, disable embedding and paste hosted URLs.</p>
          </div>
        </section>
      </main>
    </div>
  );
}
